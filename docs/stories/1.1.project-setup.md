# Story 1.1: project-setup

## Status
InProgress

## Story
**As a** 开发者,
**I want** 搭建支持AD9226电压采集和热噪声分析的完整项目基础架构,
**so that** 团队可以在统一的环境中开发和部署实时数据处理和噪声分析功能

## Acceptance Criteria
1. 创建前后端分离的项目结构，包含frontend和backend目录，支持实时数据流处理
2. 配置TypeScript、ESLint、Prettier等开发工具，包含科学计算库
3. 设置Docker开发环境，包含PostgreSQL、Redis和串口通信支持
4. 配置GitHub Actions CI/CD流水线，实现自动化测试和部署
5. 创建支持实时数据的数据库schema，包含设备管理和分区表
6. 实现串口通信基础服务和健康检查接口，支持WebSocket实时推送

## Tasks / Subtasks
- [ ] Task 1: 创建项目基础结构 (AC: 1)
  - [ ] 创建根目录下的 frontend/ 和 backend/ 目录
  - [ ] 在 frontend/ 中设置 React + TypeScript + Vite 项目，集成科学计算库
  - [ ] 在 backend/ 中设置 Node.js + Express + TypeScript 项目，包含串口通信库
  - [ ] 配置基础的 package.json 依赖和脚本，包含实时数据处理相关库

- [ ] Task 2: 配置开发工具和代码质量 (AC: 2)
  - [ ] 前端配置 TypeScript 5.x、ESLint、Prettier、Ant Design 5.x
  - [ ] 前端添加科学计算依赖：ml-matrix、fft.js、Chart.js、Socket.io-client
  - [ ] 后端配置 TypeScript 5.x、ESLint、Prettier、Prisma ORM
  - [ ] 后端添加串口和信号处理依赖：serialport、Socket.io、fft-js、ml-matrix
  - [ ] 设置统一的代码格式化和质量规范
  - [ ] 配置 IDE 集成和开发体验优化

- [ ] Task 3: Docker 容器化配置 (AC: 3)
  - [ ] 创建 frontend/Dockerfile 和 backend/Dockerfile
  - [ ] 创建根目录的 docker-compose.yml 开发环境配置
  - [ ] 配置 PostgreSQL 15 和 Redis 7 服务容器
  - [ ] 设置串口设备映射和权限配置 (Linux 环境)
  - [ ] 设置容器间网络和数据卷持久化

- [ ] Task 4: CI/CD 流水线配置 (AC: 4)
  - [ ] 创建 .github/workflows/ci.yml 自动化测试
  - [ ] 创建 .github/workflows/deploy.yml 部署流水线
  - [ ] 配置 Jest 测试框架，包含科学计算算法测试
  - [ ] 设置代码质量检查和安全扫描

- [ ] Task 5: 数据库连接和配置 (AC: 5)
  - [ ] 设计支持实时数据的 Prisma schema.prisma
  - [ ] 创建用户表、设备表、实时数据分区表
  - [ ] 创建噪声分析任务表和结果表
  - [ ] 配置 PostgreSQL 连接和 Redis 缓存
  - [ ] 创建数据库迁移和种子数据脚本

- [ ] Task 6: 串口通信和健康检查基础服务 (AC: 6)
  - [ ] 实现串口设备发现和连接服务
  - [ ] 创建 WebSocket 服务支持实时数据推送
  - [ ] 实现 GET /api/health 健康检查接口，包含串口状态
  - [ ] 创建全局错误处理中间件和请求日志
  - [ ] 实现基础的串口数据解析（AD9226格式）
  - [ ] 添加基础的API响应格式标准化

## Dev Notes

### 技术栈配置
[Source: architecture/technical-solutions.md#前端架构]
- **前端**: React 18.x + TypeScript 5.x + Ant Design 5.x + Vite + Redux Toolkit
- **前端科学计算**: ml-matrix + fft.js + Chart.js + Socket.io-client
- **后端**: Node.js 18.x + Express.js 4.x + TypeScript 5.x + Prisma ORM
- **后端专业库**: serialport + @serialport/parser-readline + Socket.io + fft-js + ml-matrix
- **数据库**: PostgreSQL 15 + Redis 7
- **测试**: Jest + React Testing Library + Supertest

### 项目结构规范
[Source: architecture/technical-solutions.md#项目结构]
```
project-root/
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── common/         # 基础组件
│   │   │   ├── charts/         # 图表组件(波形、频谱、噪声分析)
│   │   │   ├── realtime/       # 实时数据显示组件
│   │   │   ├── noise-analysis/ # 噪声分析专用组件
│   │   │   └── upload/         # 上传组件
│   │   ├── pages/
│   │   │   ├── RealTimeMonitor/   # 实时监测页面
│   │   │   ├── NoiseAnalysis/     # 噪声分析页面
│   │   │   └── Dashboard/         # 综合仪表板
│   │   ├── hooks/
│   │   │   ├── useSerialData.ts   # 串口数据Hook
│   │   │   ├── useNoiseFilter.ts  # 噪声滤波Hook
│   │   │   └── useRealtime.ts     # 实时数据Hook
│   │   ├── services/
│   │   │   ├── serialService.ts   # 串口通信服务
│   │   │   └── noiseService.ts    # 噪声分析服务
│   │   └── utils/
│   │       ├── signal-processing/ # 信号处理工具
│   │       ├── noise-filters/     # 噪声滤波算法
│   │       └── thermal-noise/     # 热噪声计算工具
├── backend/
│   ├── src/
│   │   ├── controllers/
│   │   │   ├── serial.controller.ts      # 串口通信控制器
│   │   │   └── noise.controller.ts       # 噪声分析控制器
│   │   ├── services/
│   │   │   ├── serial.service.ts         # 串口通信服务
│   │   │   ├── noise-filter.service.ts   # 噪声滤波服务
│   │   │   └── thermal-noise.service.ts  # 热噪声计算服务
│   │   ├── algorithms/         # 算法模块
│   │   │   ├── signal-processing/        # 信号处理算法
│   │   │   ├── noise-filters/           # 噪声滤波器
│   │   │   └── thermal-noise/           # 热噪声相关
│   │   ├── websocket/          # WebSocket处理
│   │   │   ├── serial-handler.ts         # 串口数据实时传输
│   │   │   └── analysis-handler.ts       # 分析结果实时推送
│   │   └── routes/
│   │       ├── serial.routes.ts          # 串口相关路由
│   │       └── noise.routes.ts           # 噪声分析路由
└── docker-compose.yml
```

### 数据库设计
[Source: architecture/database-design.md#核心用户和设备表]
关键数据表结构：
- **users表**: 用户基础信息，UUID主键
- **devices表**: AD9226设备管理，串口配置，连接状态
- **realtime_data表**: 实时采集数据，分区表设计，支持高频写入
- **noise_analysis_tasks表**: 噪声分析任务管理
- **noise_analysis_results表**: 分析结果存储，包含质量评分

关键字段说明：
```sql
-- 实时数据表核心字段
timestamp BIGINT,              -- 微秒级时间戳
voltage DECIMAL(10,6),         -- AD9226电压值  
temperature DECIMAL(8,3),      -- 温度传感器数据
resistance DECIMAL(12,6),      -- 电阻值
adc_raw_value INTEGER         -- 12位ADC原始值
```

### 串口通信配置
[Source: architecture/technical-solutions.md#技术选型]
核心串口通信参数：
- 默认波特率：115200
- 数据格式：8N1 (8位数据，无奇偶校验，1位停止位)
- 数据解析：逐行解析STM32发送的CSV格式数据
- 缓冲区大小：4096字节
- WebSocket推送：实时数据流 + 分析结果流

### API 设计标准
[Source: architecture/technical-solutions.md#API设计规范]
关键API接口：
```typescript
// 健康检查扩展格式
GET /api/health
Response: {
  status: 'ok' | 'error',
  timestamp: ISO_DATE_STRING,
  services: {
    database: 'connected' | 'disconnected',
    redis: 'connected' | 'disconnected',
    serialPort: 'connected' | 'disconnected' | 'not_configured'
  },
  deviceInfo?: {
    connectedDevices: number,
    activeDataStreams: number
  }
}

// 串口连接接口
POST /api/serial/connect
Request: { port: string, baudRate: number }
Response: { success: boolean, deviceId: string }
```

### 算法模块架构  
[Source: architecture/noise-analysis-modules.md]
核心算法组织结构：
- **FFTProcessor**: 快速傅里叶变换和频域分析
- **DigitalFilters**: 数字滤波器集合（低通、高通、带通、带阻）
- **LineFrequencyFilter**: 专用50Hz工频干扰滤波器
- **SwitchingNoiseFilter**: 开关电源纹波滤波器  
- **JohnsonNyquistNoise**: 热噪声理论计算和实测分析
- **DataQualityScorer**: 数据质量评分算法

### 容器化部署配置
[Source: architecture/deployment.md#Docker配置]
- Frontend: nginx:alpine 基础镜像，构建静态资源部署
- Backend: node:18-alpine 基础镜像，支持串口设备访问
- 开发环境端口映射: Frontend(3000:80), Backend(3001:3000)
- 串口设备映射: --device=/dev/ttyUSB0:/dev/ttyUSB0 (Linux)
- 数据持久化: postgres_data、redis_data 和 analysis_results 数据卷

### 实时数据处理要求
性能指标：
- 数据处理延迟: < 100ms
- 支持采样率: 最高 100kHz
- 缓冲区大小: 4096 采样点
- 分析窗口: 1024 采样点滑动窗口
- WebSocket 推送频率: 10Hz (100ms 间隔)

### Testing
测试文件结构和标准:
- 前端测试: `src/__tests__/` 目录，使用 Jest + React Testing Library
- 后端测试: `src/__tests__/` 目录，使用 Jest + Supertest  
- 算法测试: 专门的算法单元测试，验证数学计算精度
- 串口模拟测试: 使用虚拟串口或模拟数据进行集成测试
- 实时性能测试: WebSocket连接和数据流性能测试
- 覆盖率目标: 代码覆盖率不低于80%
- 测试命名: `*.test.ts` 或 `*.test.tsx`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation | SM Agent |
| 2025-08-31 | 1.1 | Updated for AD9226 and noise analysis requirements | SM Agent |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No critical errors encountered during implementation.

### Completion Notes List
- ✅ **Task 1**: 创建项目基础结构 - 完成前后端目录结构，包含专业算法模块
- ✅ **Task 2**: 配置开发工具和代码质量 - 完成TypeScript配置，集成科学计算库
- ✅ **Task 3**: Docker容器化配置 - 完成开发和生产环境Docker配置
- ✅ **Task 4**: CI/CD流水线配置 - 完成GitHub Actions自动化测试和部署
- ✅ **Task 5**: 数据库连接和配置 - 完成Prisma schema和数据库种子
- ✅ **Task 6**: 串口通信和健康检查基础服务 - 完成串口服务、WebSocket和API路由

### File List
**前端文件 (Frontend)**:
- `frontend/package.json` - 前端依赖配置，包含科学计算库
- `frontend/tsconfig.json` - TypeScript配置
- `frontend/vite.config.ts` - Vite构建配置
- `frontend/src/main.tsx` - React应用入口
- `frontend/src/App.tsx` - 主应用组件
- `frontend/src/store/index.ts` - Redux store配置
- `frontend/src/pages/*/index.tsx` - 基础页面组件 (Home, RealTimeMonitor, NoiseAnalysis, DataUpload, Dashboard)
- `frontend/src/styles/index.css` - 全局样式，包含科学数据显示样式
- `frontend/src/utils/signal-processing/fft.ts` - FFT处理工具
- `frontend/src/utils/signal-processing/filters.ts` - 数字滤波器
- `frontend/src/utils/noise-filters/line-filter.ts` - 工频干扰滤波器
- `frontend/src/utils/thermal-noise/johnson-nyquist.ts` - 热噪声计算工具
- `frontend/Dockerfile` - 生产环境Docker配置
- `frontend/nginx.conf` - Nginx配置，包含API代理和WebSocket支持

**后端文件 (Backend)**:
- `backend/package.json` - 后端依赖配置，包含串口通信库
- `backend/tsconfig.json` - TypeScript配置，支持路径映射
- `backend/src/server.ts` - Express服务器，集成WebSocket和路由
- `backend/src/config/logger.ts` - Winston日志配置
- `backend/src/middleware/error.middleware.ts` - 全局错误处理中间件
- `backend/src/services/serial.service.ts` - 串口通信服务，支持AD9226数据解析
- `backend/src/controllers/serial.controller.ts` - 串口API控制器
- `backend/src/routes/serial.routes.ts` - 串口相关路由
- `backend/src/algorithms/signal-processing/fft.ts` - 后端FFT处理算法
- `backend/prisma/schema.prisma` - 数据库模型，支持实时数据分区表
- `backend/prisma/seed.ts` - 数据库种子数据
- `backend/healthcheck.js` - Docker健康检查脚本
- `backend/Dockerfile` - 生产环境Docker配置
- `backend/Dockerfile.dev` - 开发环境Docker配置
- `backend/.env.example` - 环境变量模板

**Docker和部署**:
- `docker-compose.yml` - 生产环境容器编排
- `docker-compose.dev.yml` - 开发环境容器编排，包含管理工具
- `start-dev.sh` / `start-dev.bat` - 跨平台开发环境启动脚本

**CI/CD**:
- `.github/workflows/ci-cd.yml` - GitHub Actions自动化测试和部署流水线

## QA Results
*This section will be populated by QA agent after implementation review*